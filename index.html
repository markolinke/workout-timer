<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Rep Interval Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .workout-title {
      display: inline;
    }

    .workout-menu-trigger {
      color: #888;
      cursor: pointer;
      font-size: 0.6em;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .workout-menu-trigger:hover {
      color: #4CAF50;
      background: rgba(255, 255, 255, 0.1);
    }

    .container {
      max-width: 558px;
      margin: 0 auto;
      padding: 20px;
      background: #333;
      border-radius: 15px;
    }

    .settings {
      margin: 20px 0;
    }

    label {
      display: inline-block;
      width: 180px;
      text-align: right;
      margin: 8px;
    }

    input {
      width: 70px;
      padding: 8px;
      font-size: 1.2em;
      text-align: center;
    }

    button {
      padding: 14px 32px;
      font-size: 1.4em;
      margin: 12px 8px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      min-width: 140px;
    }

    #mainBtn {
      background: #4CAF50;
      color: white;
      font-weight: bold;
    }



    #resetBtn {
      background: #555;
      color: white;
    }

    .timer-display {
      font-size: 5.5em;
      margin: 30px 0;
      font-weight: bold;
    }

    .progress {
      font-size: 1.3em;
      color: #aaa;
    }

    .beep {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    /* FLAMBOYANT SCOREBOARD STYLES */
    .scoreboard-container {
      display: block;
      width: fit-content;
      max-width: 100%;
      box-sizing: border-box;
      /* overflow-x: auto;  <-- REMOVED so the container (and progress bar) doesn't scroll */
      margin: 25px auto;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), inset 0 1px 1px rgba(255, 255, 255, 0.1);
      background: linear-gradient(145deg, #0a1f44, #051025);
      /* Midnight Blue Gradient */
      padding: 15px;
      border: 1px solid #1e3a6e;
    }

    .sb-table {
      border-collapse: separate;
      /* Allow spacing */
      border-spacing: 6px;
      /* Gap between cells */
      color: #fff;
      font-family: 'Verdana', sans-serif;
    }

    .sb-table th,
    .sb-table td {
      border: none;
      /* Remove default borders */
      padding: 10px 5px;
      text-align: center;
      min-width: 45px;
      border-radius: 8px;
      /* Rounded cells */
      position: relative;
      transition: all 0.3s ease;
    }

    /* Header Column (Planned / Completed) */
    .sb-header-col {
      background: transparent;
      color: #88aadd;
      font-weight: bold;
      text-align: right;
      padding-right: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.8em;
      width: 100px;
      border: none !important;
    }

    /* Row Styling */
    .row-planned td:not(.sb-header-col) {
      background-color: rgba(255, 255, 255, 0.05);
      color: #aaa;
      font-size: 0.9em;
    }

    .row-completed td:not(.sb-header-col) {
      background-color: rgba(255, 255, 255, 0.1);
      font-weight: bold;
      font-size: 1.2em;
    }

    /* Active Column Highlight - THE FLAMBOYANT PART */
    .col-active {
      background-color: #ccff00 !important;
      /* Neon Tennis Yellow */
      color: #000 !important;
      box-shadow: 0 0 15px rgba(204, 255, 0, 0.6);
      /* Glow */
      transform: scale(1.1);
      z-index: 10;
      border: 2px solid #fff;
    }

    /* Future/Past Column Styling */
    .col-future {
      opacity: 0.5;
    }

    .col-past {
      background-color: #004d25 !important;
      /* Wimbledon Green */
      color: #fff !important;
      border: 1px solid #006633;
    }

    /* Pulse Animation for Active Cell */
    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 10px rgba(204, 255, 0, 0.4);
      }

      50% {
        box-shadow: 0 0 20px rgba(204, 255, 0, 0.8);
      }

      100% {
        box-shadow: 0 0 10px rgba(204, 255, 0, 0.4);
      }
    }

    .col-active {
      animation: pulse-glow 2s infinite;
    }

    /* MODAL STYLES */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      border: 1px solid #444;
    }

    .modal-header {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #4CAF50;
      text-align: center;
    }

    .workout-option {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background: #333;
      border: 1px solid #555;
      border-radius: 10px;
      color: #fff;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .workout-option:hover {
      background: #4CAF50;
      border-color: #4CAF50;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .modal-close {
      margin-top: 20px;
      padding: 10px;
      background: #555;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      width: 100%;
      font-size: 1em;
    }

    .modal-close:hover {
      background: #666;
    }

    @media (max-width: 600px) {
      body {
        padding-left: 80px;
        padding-right: 10px;
      }
    }
  </style>
</head>

<body>

  <div class="container">

    <!-- VISUAL CUE BAR – Rep -->
    <div id="calfBarContainer"
      style="position:fixed; left:15px; top:15%; width:56px; height:70%; background:#111; border:3px solid #555; border-radius:14px; overflow:hidden; z-index:10; box-shadow:0 0 15px rgba(0,0,0,0.8);">
      <div id="calfBar"
        style="width:100%; height:100%; background:linear-gradient(to bottom, #4CAF50, #2e7d32); transform:scaleY(1); transform-origin:top; transition:transform 0.08s linear;">
      </div>
    </div>

    <h1>
      <span class="workout-title" id="workoutTitle">Rep Interval Timer</span>
      <a class="workout-menu-trigger" id="workoutMenuTrigger">...</a>
    </h1>

    <!-- SETUP CONTAINER -->
    <div id="setup-container">
      <div class="settings">
        <div><label>Rounds:</label> <input type="number" id="rounds" min="1"></div>
        <div><label>Reps per round:</label> <input type="number" id="reps" min="1"></div>
        <div><label>Work per rep (sec):</label> <input type="number" id="work" min="1"></div>
        <div><label>Rest between reps (sec):</label> <input type="number" id="rest" min="0"></div>
        <div><label>Rest between rounds (sec):</label> <input type="number" id="roundRest" min="0"></div>
      </div>

      <div style="margin: 20px 0; font-size: 1.4em; color: #aaa;">
        Total workout: <strong id="totalTimeDisplay">—</strong>
      </div>
    </div>

    <div>
      <button id="mainBtn">START</button>

      <button id="resetBtn">RESET</button>
    </div>

    <!-- RUNNING CONTAINER -->
    <div id="running-container" class="hidden">
      <div class="timer-display" id="timer">00:00</div>
      <!-- GRID SCOREBOARD -->
      <div class="scoreboard-container">
        <div style="overflow-x: auto; width: 100%; padding-bottom: 5px;">
          <table class="sb-table" id="sbTable">
            <!-- Generated by JS -->
          </table>
        </div>

        <!-- TOTAL PROGRESS BAR -->
        <div id="totalBarContainer" style="margin-top: 15px; width: 100%;">
          <div
            style="width: 100%; height: 18px; background: #111; border-radius: 9px; overflow: hidden; border: 2px solid #555;">
            <div id="totalBar"
              style="width: 100%; height: 100%; background: linear-gradient(to right, #4CAF50, #2e7d32); transform: scaleX(0); transform-origin: left; transition: transform 0.08s linear;">
            </div>
          </div>
        </div>
      </div>

      <div class="progress" id="progress"></div>
    </div>
  </div>

  <audio id="beep" class="beep" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="
    preload="auto"></audio>

  <!-- WORKOUT SELECTION MODAL -->
  <div id="workoutModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Select Workout</div>
      <div id="workoutList">
        <!-- Generated by JS -->
      </div>
      <button class="modal-close" id="modalClose">Close</button>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Functions are now global from script.js
    // Predefined workouts
    const PREDEFINED_WORKOUTS = [
      {
        id: 'alfredson',
        name: 'Alfredson Protocol',
        config: {
          rounds: 6,
          reps: 15,
          work: 5,
          rest: 1,
          roundRest: 30
        }
      },
      {
        id: 'calf-2x15',
        name: 'Calf raise 2x15',
        config: {
          rounds: 2,
          reps: 12,
          work: 3,
          rest: 3,
          roundRest: 20
        }
      },
      {
        id: 'test-1r-1rep',
        name: 'Test: 1R x 1Rep',
        config: {
          rounds: 1,
          reps: 1,
          work: 1,
          rest: 1,
          roundRest: 1
        }
      },
      {
        id: 'test-2r-1rep',
        name: 'Test: 2R x 1Rep',
        config: {
          rounds: 2,
          reps: 1,
          work: 1,
          rest: 1,
          roundRest: 2
        }
      },
      {
        id: 'test-1r-2reps',
        name: 'Test: 1R x 2Reps',
        config: {
          rounds: 1,
          reps: 2,
          work: 1,
          rest: 1,
          roundRest: 1
        }
      },
      {
        id: 'test-2r-2reps',
        name: 'Test: 2R x 2Reps',
        config: {
          rounds: 2,
          reps: 2,
          work: 1,
          rest: 1,
          roundRest: 2
        }
      }
    ];

    // Default configuration values (Alfredson Protocol)
    const DEFAULT_CONFIG = PREDEFINED_WORKOUTS[0].config;
    let currentWorkout = PREDEFINED_WORKOUTS[0];

    const beep = document.getElementById('beep');
    const timerDisplay = document.getElementById('timer');
    const progressDisplay = document.getElementById('progress');
    const mainBtn = document.getElementById('mainBtn');

    const setupContainer = document.getElementById('setup-container');
    const runningContainer = document.getElementById('running-container');
    const tickTime = 100;

    let countdown;
    let totalSeconds = 0;
    let totalWorkoutSeconds = 0;
    let currentRound = 1;
    let currentRep = 1;
    let isWorking = true;
    let isRoundRest = false;
    let isRunning = false;
    let isPaused = false;
    let workoutStartedAt = null;        // timestamp when START was pressed
    let pausedTimeTotal = 0;           // total seconds spent paused
    let lastPauseStart = null;        // when current pause began
    let getReadyActive = false;

    // Simple calf drop visual bar
    const calfBar = document.getElementById('calfBar');

    function toggleView(showRunning) {
      if (showRunning) {
        setupContainer.classList.add('hidden');
        runningContainer.classList.remove('hidden');
      } else {
        setupContainer.classList.remove('hidden');
        runningContainer.classList.add('hidden');
      }
    }

    function updateVisualBars() {
      if (getReadyActive || !isRunning) {
        calfBar.style.display = 'none';
        return;
      }
      calfBar.style.display = 'block';

      if (isWorking) {
        // WORK = lowering = fill from TOP to BOTTOM
        const progress = (parseInt(document.getElementById('work').value) - totalSeconds) / parseInt(document.getElementById('work').value);
        calfBar.style.transform = `scaleY(${progress})`;
        calfBar.style.transformOrigin = 'top';
        calfBar.style.background = 'linear-gradient(to bottom, #4CAF50, #2e7d32)';  // green
      } else if (!isRoundRest) {
        // SHORT REST = rising = fill from BOTTOM to TOP
        const restTime = parseInt(document.getElementById('rest').value);
        const progress = (restTime - totalSeconds) / restTime;
        calfBar.style.transform = `scaleY(${progress})`;
        calfBar.style.transformOrigin = 'bottom';
        calfBar.style.background = 'linear-gradient(to top, #ff9800, #e65100)';     // orange
      } else {
        // During long round rest → hide or keep orange (your choice)
        calfBar.style.display = 'none';
      }
    }

    function playBeep(times = 1, delay = 200) {
      if (times > 0) {
        beep.currentTime = 0;
        beep.play();
        setTimeout(() => playBeep(times - 1, delay), delay);
      }
    }

    function updateDisplay() {
      timerDisplay.textContent = formatTime(totalSeconds);
    }

    function updateProgress() {
      const rounds = parseInt(document.getElementById('rounds').value);
      const repsPerRound = parseInt(document.getElementById('reps').value);
      const workSec = parseInt(document.getElementById('work').value);
      const restSec = parseInt(document.getElementById('rest').value);
      const roundRestSec = parseInt(document.getElementById('roundRest').value);

      const totalReps = rounds * repsPerRound;

      // Completed reps (same logic as before — this part was actually fine)
      let completedReps = (currentRound - 1) * repsPerRound;
      if (isRoundRest) {
        completedReps += repsPerRound;
      } else {
        completedReps += isWorking ? (currentRep - 1) : currentRep;
      }

      // ───── CALCULATE ACTUAL REMAINING TIME ─────
      // Instead of using elapsed time (which can drift), calculate based on actual remaining phases
      const remaining = calculateRemainingTime(
        currentRound,
        currentRep,
        isWorking,
        isRoundRest,
        rounds,
        repsPerRound,
        workSec,
        restSec,
        roundRestSec,
        totalSeconds
      );

      const remainingRounded = Math.ceil(remaining);
      const mins = Math.floor(remainingRounded / 60);
      const secs = (remainingRounded % 60).toString().padStart(2, '0');
      const timeLeft = remainingRounded >= 60 ? `${mins}m ${secs}s left` : `${remainingRounded}s left`;
      const workoutProgressPct = totalWorkoutSeconds > 0 ? Math.floor(((totalWorkoutSeconds - remaining) / totalWorkoutSeconds) * 100) : 0;

      // Update Scoreboard Grid
      updateScoreboardGrid();

      progressDisplay.innerHTML = `
    Total Reps: <strong>${completedReps}</strong>/${totalReps} &nbsp;•&nbsp; 
    Time Left: <span style="color:#4CAF50;">${timeLeft}</span>
  `;

      // Update the total bar to fill from left to right
      const totalBar = document.getElementById('totalBar');
      totalBar.style.transform = `scaleX(${workoutProgressPct / 100})`;
      totalBar.style.transformOrigin = 'left';
      totalBar.style.background = 'linear-gradient(to right, #4CAF50, #2e7d32)';

    }

    function tick() {
      totalSeconds -= tickTime / 1000;
      updateDisplay();      // big 00:00 timer
      updateProgress();     // ← THIS LINE IS THE KEY (updates total remaining time every second)
      updateVisualBars();

      // BACKGROUND COLOR LOGIC
      // BACKGROUND COLOR LOGIC
      document.body.style.background =
        isWorking ? '#222' :
          isRoundRest ? '#e65100' : '#ff9800';   // dark orange for round rest, bright for rep rest

      const baseColor = isWorking ? '#fff' : '#000';
      document.body.style.color = baseColor;

      // TIMER TEXT COLOR LOGIC
      if (totalSeconds <= 3 && totalSeconds > 0) {
        if (!isWorking && !isRoundRest) {
          timerDisplay.style.color = '#4CAF50'; // Green for rest between reps
        } else {
          timerDisplay.style.color = '#ff0000'; // Red for work and round rest
        }
      } else {
        timerDisplay.style.color = ''; // Inherit from body
      }

      if (totalSeconds <= 0) {
        playBeep(3, 150);
        nextPhase();
      }
    }

    function nextPhase() {
      const workSec = parseInt(document.getElementById('work').value);
      const restSec = parseInt(document.getElementById('rest').value);
      const roundRestSec = parseInt(document.getElementById('roundRest').value);
      const totalRounds = parseInt(document.getElementById('rounds').value);
      const repsPerRound = parseInt(document.getElementById('reps').value);

      if (isRoundRest) {
        // End of round rest → next round
        isRoundRest = false;
        currentRound++;
        currentRep = 1;
        if (currentRound > totalRounds) {
          finishWorkout();
          return;
        }
        isWorking = true;
        totalSeconds = workSec;
      } else if (isWorking) {
        // End of work → ALWAYS rest (between reps)
        isWorking = false;
        totalSeconds = restSec;
      } else {
        // End of rest (between reps)
        // Check if we finished all reps in this round
        currentRep++;
        if (currentRep > repsPerRound) {
          // Finished all reps for this round
          if (currentRound === totalRounds) {
            finishWorkout();
            return;
          }
          isRoundRest = true;
          totalSeconds = roundRestSec;
        } else {
          // Next rep
          isWorking = true;
          totalSeconds = workSec;
        }
      }

      updateProgress();
      updateDisplay();
      updateVisualBars();

      // Force correct background immediately when phase changes
      document.body.style.background =
        isWorking ? '#222' :
          isRoundRest ? '#e65100' : '#ff9800';   // dark orange for round rest, bright for rep rest

      document.body.style.color = isWorking ? '#fff' : '#000';
      timerDisplay.style.color = '';
    }

    function startTimer() {
      if (!workoutStartedAt) {
        workoutStartedAt = Date.now();   // ← first time we press START
        // Get values from inputs
        const rounds = parseInt(document.getElementById('rounds').value);
        const repsPerRound = parseInt(document.getElementById('reps').value);
        const workSec = parseInt(document.getElementById('work').value);
        const restSec = parseInt(document.getElementById('rest').value);
        const roundRestSec = parseInt(document.getElementById('roundRest').value);
        // Calculate total workout duration
        // Calculate total workout duration
        totalWorkoutSeconds = calculateTotalWorkoutTime(rounds, repsPerRound, workSec, restSec, roundRestSec);

        toggleView(true); // Switch to running view
      }

      if (isRunning && !isPaused) return;

      isRunning = true;
      isPaused = false;
      mainBtn.textContent = "PAUSE";


      const workSec = parseInt(document.getElementById('work').value);
      if (totalSeconds === 0) {
        totalSeconds = isRoundRest ? parseInt(document.getElementById('roundRest').value) :
          (isWorking ? workSec : parseInt(document.getElementById('rest').value));
        if (totalSeconds === 0) totalSeconds = workSec;
        updateProgress();
      }

      updateDisplay();
      countdown = setInterval(tick, tickTime);
    }

    function pauseTimer() {
      clearInterval(countdown);
      isPaused = true;
      mainBtn.textContent = "RESUME";

      lastPauseStart = Date.now();
    }

    function resumeTimer() {
      if (lastPauseStart) {
        pausedTimeTotal += Date.now() - lastPauseStart;
        lastPauseStart = null;
      }

      isPaused = false;
      mainBtn.textContent = "PAUSE";

      countdown = setInterval(tick, tickTime);
    }



    function resetTimer() {
      clearInterval(countdown);
      totalSeconds = 0;
      currentRound = 1;
      currentRep = 1;
      isWorking = true;
      isRoundRest = false;
      isRunning = false;
      isPaused = false;

      mainBtn.textContent = "START";


      updateDisplay();
      progressDisplay.textContent = '';
      document.body.style.background = '#222';
      document.body.style.color = '#fff';
      timerDisplay.style.color = '';

      workoutStartedAt = null;
      pausedTimeTotal = 0;
      lastPauseStart = null;
      calfBar.style.display = 'none';
      initScoreboard(); // Re-initialize scoreboard on reset

      toggleView(false); // Switch back to setup view
    }

    function finishWorkout() {
      console.log('finishWorkout');
      clearInterval(countdown);
      isRunning = false;
      isPaused = false;
      releaseWakeLock();           // ← definitely release when workout ends

      timerDisplay.textContent = "DONE!";
      progressDisplay.textContent = '';
      mainBtn.textContent = "START";

      playBeep(8, 250);
      document.body.style.background = '#1b5e20';

      // Note: We stay in running view so user can see they are done.
      // They must press RESET to go back to setup.
    }

    // Main button logic
    mainBtn.addEventListener('click', () => {
      if (!isRunning) {
        startTimer();
      } else if (isPaused) {
        resumeTimer();
      } else {
        pauseTimer();
      }
    });


    document.getElementById('resetBtn').addEventListener('click', resetTimer);

    // Press Enter to start/resume
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (mainBtn.textContent === 'START' || mainBtn.textContent === 'RESUME')) {
        mainBtn.click();
      }
    });

    // Spacebar or Enter to control Start / Pause / Resume
    document.addEventListener('keydown', (e) => {
      // Spacebar or Enter → toggle Start / Pause / Resume
      if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault(); // prevents page scroll when pressing space

        // If we're on the "START" or "RESUME" button → click it
        if (mainBtn.textContent === 'START' || mainBtn.textContent === 'RESUME') {
          mainBtn.click();
        }
        // If we're running and not already paused → pause
        else if (mainBtn.textContent === 'PAUSE' && isRunning && !isPaused) {
          mainBtn.click(); // triggers pause
        }
      }
    });

    // ──────────────────────────────
    // Prevent screen sleep / dimming / lock while timer is running
    // Works on Chrome, Edge, Safari (iOS/macOS), Firefox (with permissions)
    // ──────────────────────────────
    let wakeLock = null;

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Screen wake lock active – screen will stay on');

          // Re-request if the system tries to turn it off (some browsers release it on visibility change)
          wakeLock.addEventListener('release', () => {
            console.log('Wake lock released');
          });
        } catch (err) {
          console.warn('Wake lock failed:', err);
        }
      }
    }

    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
    }

    // Hook it into your existing timer states
    const originalStartTimer = startTimer;
    startTimer = function () {
      originalStartTimer();
      requestWakeLock();           // ← keep screen on when workout starts
    };

    const originalPauseTimer = pauseTimer;
    pauseTimer = function () {
      originalPauseTimer();
      // Optional: you can release wake lock on pause if you want the screen to dim when paused
      // releaseWakeLock();
    };



    const originalResetTimer = resetTimer;
    resetTimer = function () {
      originalResetTimer();
      releaseWakeLock();           // ← make sure it's released on reset too
    };

    // Auto-update total workout time whenever ANY setting changes
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', updateTotalWorkoutTime);
    });

    // Also update when page first loads
    // Also update when page first loads
    // updateTotalWorkoutTime(); // REMOVED: Called in initApp via loadWorkout

    function updateTotalWorkoutTime() {
      const rounds = parseInt(document.getElementById('rounds').value) || 0;
      const repsPerRound = parseInt(document.getElementById('reps').value) || 0;
      const workSec = parseInt(document.getElementById('work').value) || 0;
      const restSec = parseInt(document.getElementById('rest').value) || 0;
      const roundRestSec = parseInt(document.getElementById('roundRest').value) || 0;

      if (rounds === 0 || repsPerRound === 0) {
        document.getElementById('totalTimeDisplay').textContent = '—';
        return;
      }

      const totalTime = calculateTotalWorkoutTime(rounds, repsPerRound, workSec, restSec, roundRestSec);

      const mins = Math.floor(totalTime / 60);
      const secs = (totalTime % 60).toString().padStart(2, '0');
      document.getElementById('totalTimeDisplay').textContent =
        totalTime >= 3600 ? `${Math.floor(totalTime / 3600)}h ${mins}m ${secs}s` :
          mins > 0 ? `${mins}m ${secs}s` : `${totalTime}s`;
    }

    // Call it on page load and whenever any input changes
    // Call it on page load and whenever any input changes
    // window.addEventListener('load', updateTotalWorkoutTime); // REMOVED: Handled in initApp
    document.querySelectorAll('#rounds, #reps, #work, #rest, #roundRest').forEach(input => {
      input.addEventListener('input', updateTotalWorkoutTime);
    });

    // ──────────────────────────────
    // DYNAMIC SCOREBOARD LOGIC
    // ──────────────────────────────
    function initScoreboard() {
      const rounds = parseInt(document.getElementById('rounds').value) || 6;
      const reps = parseInt(document.getElementById('reps').value) || 15;
      const table = document.getElementById('sbTable');

      let html = '';

      // Row 1: Planned
      html += '<tr class="row-planned">';
      html += '<td class="sb-header-col">Planned</td>';
      for (let i = 1; i <= rounds; i++) {
        html += `<td id="sb-plan-${i}">${reps}</td>`;
      }
      html += '</tr>';

      // Row 2: Completed
      html += '<tr class="row-completed">';
      html += '<td class="sb-header-col">Completed</td>';
      for (let i = 1; i <= rounds; i++) {
        html += `<td id="sb-comp-${i}">0</td>`;
      }
      html += '</tr>';

      table.innerHTML = html;
      updateScoreboardGrid();
    }

    function updateScoreboardGrid() {
      const rounds = parseInt(document.getElementById('rounds').value) || 6;
      const repsPerRound = parseInt(document.getElementById('reps').value) || 15;

      for (let i = 1; i <= rounds; i++) {
        const cellPlan = document.getElementById(`sb-plan-${i}`);
        const cellComp = document.getElementById(`sb-comp-${i}`);
        if (!cellPlan || !cellComp) continue;

        // Reset classes
        cellPlan.className = '';
        cellComp.className = '';

        if (i < currentRound) {
          // Past rounds
          cellComp.textContent = repsPerRound;
          cellPlan.classList.add('col-past');
          cellComp.classList.add('col-past');
        } else if (i === currentRound) {
          // Current round
          // If we are in round rest (finished the round), show full reps, otherwise show current rep-1 (completed)
          let completedInRound = isRoundRest ? repsPerRound : currentRep - (isRunning ? 0 : 1);

          // If we are working on rep 1, completed is 0.

          cellComp.textContent = completedInRound;
          cellPlan.classList.add('col-active');
          cellComp.classList.add('col-active');
        } else {
          // Future rounds
          cellComp.textContent = '0';
          cellPlan.classList.add('col-future');
          cellComp.classList.add('col-future');
        }
      }
    }

    // Re-init scoreboard when settings change
    document.querySelectorAll('#rounds, #reps').forEach(input => {
      input.addEventListener('change', initScoreboard);
    });

    // Initialize input values from DEFAULT_CONFIG
    function initInputValues() {
      document.getElementById('rounds').value = DEFAULT_CONFIG.rounds;
      document.getElementById('reps').value = DEFAULT_CONFIG.reps;
      document.getElementById('work').value = DEFAULT_CONFIG.work;
      document.getElementById('rest').value = DEFAULT_CONFIG.rest;
      document.getElementById('roundRest').value = DEFAULT_CONFIG.roundRest;
    }

    // Load a predefined workout
    function loadWorkout(workout) {
      currentWorkout = workout;
      document.getElementById('workoutTitle').textContent = workout.name;
      document.getElementById('rounds').value = workout.config.rounds;
      document.getElementById('reps').value = workout.config.reps;
      document.getElementById('work').value = workout.config.work;
      document.getElementById('rest').value = workout.config.rest;
      document.getElementById('roundRest').value = workout.config.roundRest;
      updateTotalWorkoutTime();
      resetTimer();
    }

    // Initialize workout modal
    function initWorkoutModal() {
      const workoutList = document.getElementById('workoutList');
      const modal = document.getElementById('workoutModal');
      const trigger = document.getElementById('workoutMenuTrigger');
      const closeBtn = document.getElementById('modalClose');

      // Populate workout list
      workoutList.innerHTML = PREDEFINED_WORKOUTS.map(workout =>
        `<button class="workout-option" data-workout-id="${workout.id}">${workout.name}</button>`
      ).join('');

      // Open modal
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        modal.classList.add('show');
      });

      // Close modal
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('show');
      });

      // Close on outside click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });

      // Load workout on selection
      workoutList.addEventListener('click', (e) => {
        if (e.target.classList.contains('workout-option')) {
          const workoutId = e.target.dataset.workoutId;
          const workout = PREDEFINED_WORKOUTS.find(w => w.id === workoutId);
          if (workout) {
            loadWorkout(workout);
            modal.classList.remove('show');
          }
        }
      });
    }

    // Init on load
    // Init on load
    // Init App
    function initApp() {
      initInputValues();
      initScoreboard();
      initWorkoutModal();
      loadWorkout(currentWorkout); // Load default workout (Alfredson)
    }

    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }


  </script>
</body>

</html>